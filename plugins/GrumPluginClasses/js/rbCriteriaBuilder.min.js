/* file: rbCriteriaBuilder.js - v1.1.2 | minified on 2011/05/15 with http://jscompress.com/ */
function criteriaBuilder(container)
{var itemsId={group:'iCbGroup',item:'iCbItem',container:container},counters={group:0,item:0},options={textAND:'AND',textOR:'OR',textNoCriteria:'There is no criteria ! At least, one criteria is required to do search...',textHint:'',textSomethingWrong:'An error has occured on the server-side',textCaddieUpdated:'Caddie was updated',classGroup:'',classItem:'',classOperator:'',classHelper:'helper',opacity:0.8,onEdit:null,onDelete:null,onRequestSuccess:null,onRequestError:null,onGetPageSuccess:null,onGetPageError:null,helpEditUrl:'',helpDeleteUrl:'',helpMove:'',helpSwitchCondition:'',ajaxUrl:''},extraData=new Array();if(arguments.length==2)
{if(typeof arguments[1]=='object')
{options=jQuery.extend(options,arguments[1]);}}
this.doAction=function(fct)
{switch(fct)
{case'add':if(arguments.length==3)
{if(typeof arguments[1]=='string')
{addItem(arguments[1],arguments[2]);}}
break;case'delete':if(arguments.length==2)
{if(typeof arguments[1]=='string')
{deleteItem(arguments[1]);}}
break;case'edit':if(arguments.length==4)
{if(typeof arguments[1]=='string'&&typeof arguments[2]=='string')
{editItem(arguments[1],arguments[2],arguments[3]);}}
break;case'get':return(getItems());break;case'getExtraData':if(arguments.length==2)
{return(getExtraData(arguments[1]));}
else
{return(null);}
break;case'clear':clearItems();break;case'send':sendRequest();break;case'getPage':if(arguments.length==4)
{getPage(arguments[1],arguments[2],arguments[3]);}
break;case'setOptions':if(arguments.length==2)
{return(setOptions(arguments[1]));}
break;}};var addGroup=function(itemId)
{counters.group++;var content="<li id='"+itemsId.group+counters.group+"' class='cbGroup cbSortable cbOpAND "+options.classGroup+" cbItemUnique'>";content+="<ul></ul></li>";$('#'+itemId).wrap(content);content="<div class='cbSortHandle' style='display:none;'>";content+="<div class='cbItemButtons' style='float:left;'>";content+="<div class='iconMove' id='iImgMoveItem"+counters.item+"' title=\""+options.helpMove+"\"></div>";content+="<div class='iconSwitchCondition' id='iImgSwitchCItem"+counters.item+"' title=\""+options.helpSwitchCondition+"\"></div>";content+="</div>";content+="<div id='"+itemsId.group+counters.group+"OpAND' class='"+options.classOperator+"' style='display:none;'>"+options.textAND+"</div>";content+="<div id='"+itemsId.group+counters.group+"OpOR' class='"+options.classOperator+"' style='display:none;'>"+options.textOR+"</div>";content+="</div>";$("#"+itemsId.group+counters.group).prepend(content);$('#'+itemsId.group+counters.group+'OpOR, #'+itemsId.group+counters.group+'OpAND, #'+itemsId.group+counters.group+' div.iconSwitchCondition ').bind('click',itemsId.group+counters.group,onSwitchOperator);applyNested();};var removeGroup=function(groupId)
{$('#'+groupId).remove();};var addItem=function(itemContent,data)
{counters.item++;var content="<li id='"+itemsId.item+counters.item+"' class='cbItem cbSortable "+options.classItem+"'>";content+="<div class='cbItemButtons' style='float:right;'>";if(options.onEdit!=null&&jQuery.isFunction(options.onEdit))content+="<div class='iconEdit' id='iImgEdit"+counters.item+"' title=\""+options.helpEdit+"\"></div>";if(options.onDelete!=null&&jQuery.isFunction(options.onDelete))content+="<div class='iconDelete' id='iImgDelete"+counters.item+"' title=\""+options.helpDelete+"\"></div>";content+="</div><div class='cbSortHandle'>";content+="<div class='cbItemButtons' style='float:left;'> <div class='iconMove' id='iImgMoveItem"+counters.item+"' title=\""+options.helpMove+"\"></div></div>";content+="<div class='itemContent'>"+itemContent+"</div></div></li>";$('#'+itemsId.container).append(content);addGroup(itemsId.item+counters.item);if(options.onEdit!=null)$('#iImgEdit'+counters.item).bind('click',itemsId.item+counters.item,options.onEdit);if(options.onDelete!=null)$('#iImgDelete'+counters.item).bind('click',itemsId.item+counters.item,options.onDelete);extraData[counters.item]=data;};var deleteItem=function(itemId)
{if($('#'+itemId).length!=0)
{$('#'+itemId).remove();var re=/[0-9]*$/;extraData[eval(re.exec(itemId)[0])]=null;manage();}};var editItem=function(itemId,content,data)
{if($('#'+itemId).length!=0)
{$('#'+itemId+' .itemContent').html(content);var re=/[0-9]*$/;extraData[eval(re.exec(itemId)[0])]=data;}};var clearItems=function()
{$('#'+itemsId.container).NestedSortableDestroy();$('#'+itemsId.container).html("");counters.item=0;counters.group=0;extraData=new Array();};var serializeData=function(prefix,value)
{var returned='';if(typeof value=='object')
{for(var key in value)
{if(typeof value[key]=='object')
{returned+=serializeData(prefix+'['+key+']',value[key]);}
else if(typeof value[key]=='string'||typeof value[key]=='number'||typeof value[key]=='boolean')
{returned+='&'+prefix+'['+key+']='+value[key];}}}
else if(typeof value=='string'||typeof value=='number'||typeof value=='boolean')
{returned+='&'+prefix+'='+value;}
return(returned);};var getItems=function()
{var serialized=jQuery.iNestedSortable.serialize(itemsId.container)['hash'],tmp=Array();for(i=0;i<extraData.length;i++)
{if(extraData[i]!=null)
{serialized+=serializeData('extraData['+i+']',extraData[i]);}}
$('#'+itemsId.container+' .cbGroup').each(function()
{re=/[0-9]*$/;serialized+='&operator['+re.exec(this.id)[0]+']=';if($(this).hasClass('cbOpOR'))
{serialized+='OR';}
else
{serialized+='AND';}});return(serialized);};var getExtraData=function(itemId)
{var re=/[0-9]*$/;extraDataNumber=re.exec(itemId)[0];return(extraData[extraDataNumber]);};var setOptions=function(optionsToSet)
{options=jQuery.extend(options,optionsToSet);};var displayOperator=function(groupId,visible)
{if($('#'+groupId).hasClass('cbOpAND'))
{if(visible)
{$('#'+groupId+'OpAND').css('display','block');}
else
{$('#'+groupId+'OpAND').css('display','none');}}
else
{if(visible)
{$('#'+groupId+'OpOR').css('display','block');}
else
{$('#'+groupId+'OpOR').css('display','none');}}
if(visible)
{$('#'+groupId).children('div.cbSortHandle').css('display','block');}
else
{$('#'+groupId).children('div.cbSortHandle').css('display','none');}};var manage=function()
{$('#'+itemsId.container+' li').each(function()
{if($(this).hasClass('cbGroup'))
{if($('#'+this.id+' li.cbItem').length==0)
{removeGroup(this.id);}
else if($('#'+this.id+' li.cbItem').length==1)
{$('#'+this.id).addClass('cbItemUnique').removeClass('cbItemMultiple');displayOperator(this.id,false);}
else
{$('#'+this.id).removeClass('cbItemUnique').addClass('cbItemMultiple');displayOperator(this.id,true);}}
else if($(this).hasClass('cbItem'))
{if($(this).parent().get(0).id==itemsId.container)
{addGroup(this.id);}}});};var applyNested=function()
{$('#'+itemsId.container).NestedSortableDestroy();$('#'+itemsId.container).NestedSortable({accept:'cbSortable',noNestingClass:'cbItem',opacity:options.opacity,helperclass:options.classHelper,serializeRegExp:/.*/i,autoScroll:true,handle:'.cbSortHandle:first',ghosting:false,nestingPxSpace:15,currentNestingClass:'cbItemOverGroup',onChange:function(serialized){manage();}});};onSwitchOperator=function(event)
{var groupId=event.data;if($('#'+groupId).hasClass('cbOpAND'))
{$('#'+groupId).removeClass('cbOpAND').addClass('cbOpOR');$('#'+groupId+'OpAND').css('display','none');$('#'+groupId+'OpOR').css('display','block');}
else
{$('#'+groupId).removeClass('cbOpOR').addClass('cbOpAND');$('#'+groupId+'OpAND').css('display','block');$('#'+groupId+'OpOR').css('display','none');}};var sendRequest=function()
{if(extraData.length==0)
{alert(options.textNoCriteria);return(false);}
var datas=encodeURI('ajaxfct=public.rbuilder.searchExecute&requestName='+itemsId.container+'&'+getItems());$.ajax({type:"POST",url:options.ajaxUrl,async:true,data:datas,success:function(msg)
{if(options.onRequestSuccess!=null&&jQuery.isFunction(options.onRequestSuccess))options.onRequestSuccess(msg);},error:function(msg)
{if(options.onRequestError!=null&&jQuery.isFunction(options.onRequestError))options.onRequestError(msg);}});};var getPage=function(requestNumber,pageNumber,numberPerPage)
{$.ajax({type:"POST",url:options.ajaxUrl,async:true,data:{ajaxfct:'public.rbuilder.searchGetPage',page:pageNumber,requestNumber:requestNumber,numPerPage:numberPerPage},success:function(msg)
{if(options.onGetPageSuccess!=null&&jQuery.isFunction(options.onGetPageSuccess))options.onGetPageSuccess(msg);},error:function(msg)
{if(options.onGetPageError!=null&&jQuery.isFunction(options.onGetPageError))options.onGetPageError(msg);}});};applyNested();};criteriaBuilder.makeExtendedData=function(owner,data)
{return({owner:owner,param:data});}
